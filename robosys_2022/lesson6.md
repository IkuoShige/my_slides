# ロボットシステム学

## 第6回: ソフトウェアのテスト

千葉工業大学 上田 隆一

<br />

<p style="font-size:50%">
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
</p>

---

## 今日やること

* コマンドの終了ステータス
* シェルの変数
* テストコマンド
* 簡単なシェルスクリプト
* 初歩的なテスト

---

## 1. コマンドの終了ステータス

---

### コマンドの正常終了・異常終了

* コマンドは人に対してだけでなく、<br />シェルにエラーの有無を伝達
    * <span style="color:red">終了ステータス</span>と呼ばれる整数値で
* シェルはコマンドの終了ステータスを記録
    * <span style="color:red">`$?`</span>という変数に
    * 例: `ls`の出力
        ```bash
$ ls /etc/passwd   # 存在するファイルをls
/etc/passwd
$ echo $?
0                  # $?という変数にゼロが入っている。
$ ls aaaaaaaa      # 存在しないファイルをls
ls: 'aaaaaaaa' にアクセスできません: そのようなファイルやディレクトリはありません
$ echo $?
2                  # ゼロでない値が入る。
        ```

---

### `plus_stdin`の終了ステータス

* これまで書いてきた`plus_stdin`も終了ステータスを<br />シェルに伝達
    * Pythonが裏でやっているので、任せておいて問題ない
    ```bash
$ seq 3 | ./plus_stdin    # 正常な入力
6
$ echo $?
0
$ echo あ | ./plus_stdin  # ひらがなを入力してエラーを起こさせる
（エラーの表示。省略。）
$ echo $?
1
    ```

なんのために終了ステータスがあるか: あとで説明

---

## 2. シェルの変数

---

### 基本事項

* シェルは、`変数名=文字列`で、文字を記憶
* `${変数名}`で値に置換
    * 例:
    ```bash
    $ X=我々は宇宙人だ   # 変数のセット
    $ echo ${X}ぜ！      # 変数を値に
    我々は宇宙人だぜ！
    $ echo $X            # {}は省略できる（こともある）
    我々は宇宙人だ
    $ echo '$X' # 値にしないときはシングルクォートで囲う（``と混同注意）
    $X
    ```
    * `{}`が省略できない例:
    ```bash
    $ echo ${X}Z
    我々は宇宙人だZ
    $ echo $XZ
                         #変数「XZ」と解釈されるのでなにも出力されない
    ```

---

### コマンドの出力を変数に

* `変数名=$(コマンド)`
    * 通常は標準出力に出るコマンドの出力を<br />文字列として変数に格納
    * 例: `ls`の出力を変数`A`に　　　　　　　　　　　　　　
    ```bash
    $ A=$(ls)
    $ echo $A
    README.md plus_stdin  # 注意: 出力は各自異なります。
    ```

---

## 3. テストコマンド

* 以下のいずれかで、文字列を比較可能
    * その1: `test 比較したい文字列 = 比較したい文字列`
    * その2: `[ 比較したい文字列 = 比較したい文字列 ]`
    * その3: `[[ 比較したい文字列 = 比較したい文字列 ]]`
        * 例（その1〜3の違いには細かい話はありますが、<br />　　ここでは「その2」だけ）
        ```bash
        $ a=山田
        $ [ "$a" = 上田 ]       # [ はコマンドなので、引数はくっつけないようにしましょう。
        $ echo $?               #終了ステータスで確認
        1
	$ [ "$a" = 山田 ]
        $ echo $?
        0
        ```

---

## 4. 簡単なシェルスクリプト

* 今の比較をファイルに保存して実行してみましょう
    * 「`yamada.bash`」というファイルに、次のように記述
        ```bash
        #!/bin/bash
        
        a=山田
        [ "$a" = 上田 ]       
        echo $?               
        [ "$a" = 山田 ]
        echo $?
        ```
    * 実行
        * `chmod`してPythonのスクリプトと同様に実行
        ```bash
        $ chmod +x yamada.bash
        $ ./yamada.bash
        1
        0
        ```


---

## 5. 初歩的なテスト

やっと本題

---

### ここで言うテストとは

* プログラムが意図通りに動作するかを<span style="color:red">別のプログラムを書いて</span>テストすること
    * 「別のプログラム」の流れ
        1. 関数やプログラムに引数で、あるいは標準入力からデータを入力
        2. 出力を記録
        3. 期待した出力と一致するか比較<br />　

面倒だと思いますか❓

---

### テストがないと辛い

* 例: 「プログラムに機能をどんどん追加していったら、<br />最初に書いた部分がうまく動かなくなった！」<br />
    * <span style="color:red">→こまめにテストを実行していたら、<br />バグを起こした機能追加の時点で分かっていたはず</span>
    * こういう目的のテストを特に<br /><span style="color:red">「リグレッションテスト（退行テスト）」</span>と言う。<br />これからそれをやる。<br />　
* 別の例（というか続き）: 変更するとうまく動かなくなるから変更怖い！
    * いいからテスト書きましょう。

---

### こういう開発スタイルに<br />早く移行しましょう

1. こまめにテスト
2. テストに通ったらGitにコミット
3. テストに失敗して、原因不明なら前回のコミットに退却
    * `git restore`
4. さらに細かくテスト

予告: 最初の課題ではこのような経緯の分かる<br />リポジトリを各自提出してもらいます！<br />（あとから慌てても無理。コピー不可能）

---

### 「別のプログラム」の書き方

* コードのファイルの下や途中に書いたり、

---

### ここで言うテストとは

